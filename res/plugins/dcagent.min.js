(function(s,p){"object"===typeof exports&&"undefined"!==typeof module?p(exports):"function"===typeof define&&define.amd?define("DCAgent",["exports"],p):p(s.DCAgent={})})(this,function(s){function p(){}function W(a){var b,c;b=Date.now();c="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c;c=(b+16*Math.random())%16|0;b=Math.floor(b/16);return"x"===a?c.toString(16):(c&7|8).toString(16)});return(a||"")+c.replace(/-/g,"").toUpperCase()}function na(a){var b,c;for(b in a)c=a[b],a[b]=
c;(2<=arguments.length?[].slice.call(arguments,1):[]).forEach(function(d){var f;f=[];for(b in d)c=d[b],f.push(a[b]=c);return f});return a}function l(a,b,c){if("function"===typeof a)try{return a.apply(b,c)}catch(d){h("attemp error for "+a.toString(),d.stack)}}function oa(a,b,c){function d(){!1!==l(a)&&K(d,b)}c?d():K(d,b)}function h(a,b){console.log("#DCAgent: "+a);b&&console.log(b)}function pa(a){try{return a.setItem(".","."),a.removeItem("."),!0}catch(b){return!1}}function y(a,b){a=n(a);q.setItem(a,
b);X.set(a,b,365);return b}function C(a){a=n(a);return q.getItem(a)||X.get(a)}function n(a){if(L||M===a)return a;e.appId||h("appid should not be empty when you are in native env");return e.appId+"."+a}function qa(a){var b=u.hash,c="!"+a;if(b){var d=/![0-9A-Z]{32,128}/gi;(b=b.match(d))?(b=b[0].slice(1),a===b||C(Y)||(e.parentId=b,y(Y,b)),a=u.href.replace(d,c),u.replace(a)):u.replace(u.href+c)}else u.replace(u.href+"#"+c)}function Z(a,b,c,d){var f={data:{online:{},events:a||[],errors:b||[]},success:d};
c&&(f.data.reg=c);a=N(z);b=N(D);if(a.length||b.length)q.removeItem(n(z)),q.removeItem(n(D)),f.data.events=f.data.events.concat(a),f.data.errors=f.data.errors.concat(b),f.error=function(){e.debug&&h("report failed, restoring data to localStorage");E(f.data.events,z);E(f.data.errors,D)};$(f,aa)}function ba(a,b,c){a={page:encodeURIComponent(a||ra),optime:parseInt(e.initializedOn),ottime:parseInt(Date.now()/1E3),lttime:parseInt(e.loginTime/1E3)};Z([{eventid:"_DESelf_PV",labelmap:JSON.stringify(a),duration:"1"}],
null,b,function(){O+=1;l(c)})}function sa(){if(F)return F;P+=1;if(!(4<P)){var a={egret:"egret",layabox:"layabox",cocos:"cc.game",impact:"ig",phaser:"Phaser",pixi:"PIXI",create:"createjs",three:"THREE",gameMaker:"asset_get_type",playCanvas:"pc.fw",turbulenz:"TurbulenzEngine",quintus:"Quintus",melon:"me.game",lychee:"lychee",wade:"wade.addSceneObject",crafty:"Crafty",lime:"lime.Scene",enchant:"enchant",isogenic:"IgeEngine",gameclosure:"GC.Application",panda:"game.Scene",kiwi:"Kiwi",jaws:"jaws",sirius2d:"ss2d",
collie:"collie",physics:"Physics",stage:"Stage.Anim",babylon:"BABYLON"},b;for(b in a){var c=a[b];if(-1<c.indexOf(".")){var c=c.split("."),d=g[c[0]];if(d&&d[c[1]])return F=b}else if(g[c])return F=b}}}function ta(){var a;Q||(Q={appid:e.appId,accountid:e.accountId,uid:e.deviceId,appver:e.appVer,ver:ca,channel:e.channel,domain:r.domain||"",screen:G,logintime:String(parseInt(e.loginTime/1E3)),crtime:C(A)||""});a=Q;a.onlinetime=e.intervalCount*e.interval/1E3||1;a.pv=O.toString();a.engine=sa()||"";return a}
function ua(a){var b=new g.XMLHttpRequest;b.timeout=da;b.open("POST",a.url,!0);b.setRequestHeader("Content-Type","text/plain; charset=UTF-8");var c=Date.now();b.onreadystatechange=function(){if(4===this.readyState){var b=200<=this.status&&300>this.status,f=Date.now()-c;l(b?a.success:a.error,this,[this,f]);l(a.complete,this,[this,f]);this.timeout=this.onreadystatechange=null}};b.timeout=function(){var b=Date.now()-c;l(a.error,this,[this,b,!0]);l(a.complete,this,[this,b]);this.timeout=this.onreadystatechange=
null};b.send(JSON.stringify(a.data))}function va(a){var b=new egret.URLLoader,c=Date.now();b.addEventListener(egret.Event.COMPLETE,function(b){var d=Date.now()-c;b=b.target;l("success"===b.data?a.success:a.error,b,[b,d,d>=da]);l(a.complete,b,[b,d])});var d=new egret.URLRequest(a.url);d.method=egret.URLRequestMethod.POST;d.data=JSON.stringify(a.data);b.load(d)}function $(a,b){if(a.data){a.data.errors&&a.data.errors.length>v.max&&(e.debug&&h("sending too many errors, only "+v.max+" allowed"),a.data.errors=
a.data.errors.slice(0,v.max));for(var c in a.data)"number"===typeof a.data[c]&&(a.data[c]=String(a.data[c]));c=Math.abs(e.onlinetime);c>wa||0>=c?e.debug&&h("illegal online time: "+c):(c=na({headers:ta()},a.data),xa({url:b,data:c,success:function(b,c){t.succ=1;t.fail=0;t.total=c;l(a.success,b,[b,c])},error:function(b,c,g){t.succ=0;t.fail+=1;t.total+=c;l(a.error,b,[b,c,g]);g&&e.debug&&h("report timeout, network infomation",t)},complete:function(b,c){E({eventid:ya,labelmap:JSON.stringify(t),duration:"1"},
z);l(a.complete,b,[b,c])}}),e.debug&&h("report data:",c))}}function N(a){a=n(a);try{var b=JSON.parse(q.getItem(a));return Array.isArray(b)?b:[]}catch(c){return q.removeItem(a),[]}}function E(a,b){b=n(b);var c=N(b);Array.isArray(a)?a.forEach(function(a){return c.push(a)}):c.push(a);q.setItem(b,JSON.stringify(c))}function za(){g.addEventListener&&g.addEventListener("error",function(a){l(function(){if(v.isReportAllowed(a.filename)){v.count+=1;var b={};["colno","filename","lineno","message"].forEach(function(c){return b[c]=
a[c]||"0"});var c=a.error||{};b.stack=c.stack||"";b.type=c.name||"Error";b.timestamp=parseInt(a.timeStamp/1E3);E(b,D)}})},!1)}function Aa(){l(function(){if(g[H])g[H]=null;else if("function"===typeof define&&define.amd)require.undef(H);else if("object"===typeof s&&"undefined"!==typeof module){var a=require.resolve(H);delete require.cache[a]}else h("unknown module system, unload DCAgent manually please");h("DCAgent has been destroyed.")})}function Ba(){if(ea)return Aa(),!1;r.hidden||(e.intervalCount+=
1,B.setItem(n(R),e.intervalCount),Z());return!0}function S(a,b){if(!w.isAgentReady()){var c=[a];[].forEach.call(b,function(a){return c.push(a)});I.push(c);return!0}}function Ca(a){a=n(a);try{var b=JSON.parse(q.getItem(a));return Array.isArray(b)?b:[]}catch(c){return q.removeItem(a),[]}}function Da(a,b){b=n(b);var c=Ca(b);Array.isArray(a)?a.forEach(function(a){return c.push(a)}):c.push(a);q.setItem(b,JSON.stringify(c))}function fa(a,b,c){if(!a)h("invoke failed, missing eventId");else if(!S("onEvent",
arguments)){if(null==b||1>b)b=1;var d,f;if(c&&"[object Object]"===Ea.call(c)){for(d in c)f=c[d],c[d]=encodeURIComponent(f);d=JSON.stringify(c)}else d="";Da({eventid:a,duration:String(b),labelmap:d},z)}}function ga(a){S("onPageView",arguments)||ba(a)}function ha(a){a&&a.hasOwnProperty("amount")&&!S("onPayment",arguments)&&(a.amount=parseFloat(a.amount)||0,$({data:{payment:{currencyAmount:a.amount.toFixed(2),currencyType:a.currencyType||"CNY",payType:String(a.payType||""),iapid:String(a.iapid||""),
orderId:String(a.orderId||""),payTime:String(a.payTime||"")}}},aa))}function ia(a,b,c,d){b&&y(M,a);e.deviceId=a;e.accountId=e.accountId||a;var f=B.getItem(n(ja));f||(f=Date.now(),B.setItem(n(ja),f));e.loginTime=f;f=B.getItem(n(R));f||(f="0",B.setItem(n(R),f));e.intervalCount=parseInt(f);e.interval=1E3*Math.max(10,parseFloat(c.interval||e.interval));e.virus&&Fa(a);c.errorReport&&(c.excludes&&(v.excludes=v.excludes.concat(c.excludes)),za());c=null;b&&(c={isact:b,isreg:1},e.parentId&&(c.parentid=e.parentId),
k.localStorage||(c.localstorage=1));e.initializedOn=Date.now()/1E3;C(A)||y(A,e.initializedOn);ba(null,c,function(){w.setReadyState(3);for(var b={onEvent:fa,onPageView:ga,onPayment:ha},c=0,f=I.length;c<f;c++){var h=I[c];b[h.shift()].apply(g,h)}I.length=0;oa(Ba,e.interval);"function"===typeof d&&d(a)})}function Ga(a){function b(c){l(function(){if(0===ka.indexOf(c.origin)){var d=JSON.parse(c.data);g.removeEventListener("message",b,!1);y(A,d.crtime);a(d.id)}})}g.addEventListener("message",b,!1);var c=
r.createElement("iframe");c.style.display="none";c.src=ka;c.onload=function(){this.onload=null;this.parentNode.removeChild(this)};var d=function(){return r.body.appendChild(c)};r.body?d():r.addEventListener("DOMContentLoaded",d,!1)}function Ha(a){y(A,parseInt(Date.now()/1E3));if(k.engine.layabox){var b=layabox.getDeviceInfo()||{},c=b.mac||b.idfa||W(la()),c=c.replace(/[-_:=\s]+/g,"").toUpperCase();if(32>c.length){for(var b=c,c=Math.ceil(32-c.length)/2,c=void 0===c?0:c,d="",e=0;e<c;e+=1)d+="0A";c=b+
d}a(c)}else a(W(la()))}function la(){return k.engine.egret?T+Ia:k.engine.layabox?T+Ja:T+Ka}var x=(0,eval)("this"),g=x||{},r=x.document||{},u=x.location||{},e={appId:"",deviceId:"",accountId:"",channel:"",appVer:"",interval:10,intervalCount:0,loginTime:0,debug:g.DCAGENT_DEBUG_OPEN},k={get engine(){return U},get localStorage(){return La},get sessionStorage(){return Ma},get postMessage(){return Na},get realBrowser(){return L},get cookie(){return Oa}},m;"function"===typeof r.createElement&&(x=r.createElement("div"))&&
"function"===typeof x.querySelector&&(x.innerHTML="<i></i>",m=x.querySelector("i"),m=!!m&&"I"===m.tagName);var U={egret:"undefined"!==typeof egret,layabox:"undefined"!==typeof layabox},La=!!g.localStorage||!!U.egret,Ma=!!g.sessionStorage,Na=!!g.postMessage,L=!!m,Oa=L&&"cookie"in r,K=g.setTimeout;U.egret&&(K=function(a,b){egret.setTimeout(a,g,b)});var Ea=Object.prototype.toString;m={getItem:p,setItem:p,removeItem:p};var q=k.localStorage?g.localStorage:m,B=k.sessionStorage?g.sessionStorage:m;k.engine.egret&&
(q=egret.localStorage);var A="dcagent_create_time",T="ND",Ia="EGRET",Ja="LAYA",Ka="UE",Y="dcagent_parent_id",z="dcagent_client_events",D="dcagent_client_errors",ja="dcagent_login_time",R="dcagent_interval_key",M="dcagent_client_id",aa="http://rd.gdatacube.net/dc/html5/sync",ka="http://rd.gdatacube.net/dc/html5/whoami",ya="_DESelf_OSS",da=3E4,H="DCAgent",wa=172800,ma,X=ma=k.cookie?{get:function(a){return(a=r.cookie.match(new RegExp("(^|)\\s*"+a+"=([^\\s]*)")))&&3<=a.length?decodeURIComponent(a[2]):
null},set:function(a,b,c,d,e,g){var h;c&&(h=new Date,h.setTime(h.getTime()+864E5*c));c=c?" expires="+h.toGMTString():"";e=" path="+(e||"/");d=d?" domain="+d:"";g=g?" secure":"";r.cookie=a+"="+encodeURIComponent(b)+c+e+d+g},remove:function(a,b,c){ma.set(a,"",-1,b,c)}}:{get:p,set:p,remove:p},Fa=k.realBrowser?qa:p,J={max:100,count:0,excludes:[],isReportAllowed:function(a){if(J.count<J.max)return J.excludes.every(function(b){return-1===a.indexOf(b)})}},v=J,O=0,ra=k.realBrowser?u.pathname+u.search:"/",
ca="15";s.version=ca;m=g.screen||{};var G=m.width&&m.width+"*"+m.height;k.engine.layabox&&(G=(layabox.getDeviceInfo()||{}).resolution||"0*0");G||(G="0*0");var F,P=0,Q,t={succ:0,fail:0,total:0},xa=function(){if(g.XMLHttpRequest)return ua;if(k.engine.egret)return va;h("unknow platform, http request is not support");return p}(),ea=!1;s.teardown=function(){ea=!0};var V=0,w={getReadyState:function(){return V},setReadyState:function(a){V=a},isAgentReady:function(){return 3===V}},I=[];s.onEvent=fa;s.onPageView=
ga;s.onPayment=ha;var Pa=k.postMessage&&k.realBrowser?Ga:Ha;s.init=function(a,b){if(pa(q))if(0<w.getReadyState())h("DCAgent.init should be called only once");else if(a=a||{},a.appId){["errorReport","virus"].forEach(function(b){return e[b]=a.hasOwnProperty(b)?!!a[b]:!0});["appId","accountId","appVer"].forEach(function(b){return e[b]=a[b]||""});g.QZAppExternal&&g.QZAppExternal.getPlatform&&2==g.QZAppExternal.getPlatform()&&(h("virus disabled"),e.virus=!1);e.channel=a.channel||r.referrer||"";var c=C(M);
c?ia(c,0,a,b):(w.setReadyState(1),Pa(function(c){w.setReadyState(2);ia(c,1,a,b)}))}else h("init failed, missing appId");else k.localStorage?h("localstorage qouta error, private mode?"):h("localstorage is not supported.")};m=w.isAgentReady;Object.defineProperty(s,"readyState",{get:function(){h("DCAgent.readyState is obsolete, use DCAgent.isReady() instead");return w.getReadyState()}});s.isReady=m});
